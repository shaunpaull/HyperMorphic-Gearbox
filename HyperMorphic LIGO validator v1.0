# @title ðŸŒªï¸ HYPERMORPHIC VALIDATOR (v4.0 - SIGMA TEST)
# @markdown **Objective: Falsify the Topological Anomalies via Surrogate Testing & Coherence.**
# @markdown ---
# @markdown *Tests: Phase Scrambling (100 iterations), H1-L1 Cross-Check, and Classical Injection.*

# --- 1. ENVIRONMENT SETUP ---
import sys
import subprocess
import warnings
import os

warnings.filterwarnings("ignore")

print("[SYSTEM] Initializing Verification Cluster...")
try:
    import gwpy
except ImportError:
    print("  > Installing GWpy...")
    subprocess.check_call([sys.executable, "-m", "pip", "install", "gwpy"])

import numpy as np
import scipy.signal
import scipy.linalg
import scipy.stats
import matplotlib.pyplot as plt
from gwpy.timeseries import TimeSeries

plt.style.use('dark_background')

# --- 2. PHYSICS ENGINE (The Core Analyzer) ---

class HyperMorphicEngine:
    @staticmethod
    def calculate_sff(strain, sample_rate):
        """Spectral Form Factor calculation."""
        analytic = scipy.signal.hilbert(strain)
        phase_ev = np.unwrap(np.angle(analytic))
        energies = np.diff(phase_ev)
        
        # Topological Time Window
        t_window = np.linspace(0, 150, 300)
        k_t = []
        for t in t_window:
            z = np.sum(np.exp(1j * energies * t))
            k_t.append(np.abs(z)**2)
        return t_window, np.array(k_t)

    @staticmethod
    def count_anomalies(sff, sensitivity=1.15):
        """Counts peaks above noise floor * sensitivity."""
        # Ignore t=0 correlation peak
        tail = sff[5:]
        floor = np.mean(tail)
        peaks, _ = scipy.signal.find_peaks(tail, height=floor * sensitivity)
        return len(peaks), floor

# --- 3. VALIDATION MODULES ---

class Validator:
    @staticmethod
    def generate_surrogate(timeseries):
        """
        Creates a 'Ghost' signal.
        Preserves Power Spectrum (Amplitude) but randomizes Phase.
        Destroys Topological Winding/Non-Linearity.
        """
        data = timeseries.value
        # FFT
        f_data = np.fft.rfft(data)
        # Randomize Phase
        random_phases = np.exp(1j * np.random.uniform(0, 2*np.pi, len(f_data)))
        f_surrogate = np.abs(f_data) * random_phases
        # Inverse FFT
        surrogate = np.fft.irfft(f_surrogate, n=len(data))
        return TimeSeries(surrogate, sample_rate=timeseries.sample_rate, t0=timeseries.t0)

    @staticmethod
    def create_classical_injection(sample_rate=4096, duration=0.1):
        """
        Creates a 'Smooth' Black Hole Ringdown (Standard GR).
        Damped Sinusoid + Gaussian Noise.
        Used to prove the tool doesn't hallucinate spikes on smooth data.
        """
        t = np.linspace(0, duration, int(sample_rate*duration))
        # Standard Ringdown: f=250Hz, tau=4ms
        ringdown = np.exp(-t/0.004) * np.cos(2*np.pi*250*t)
        # Add Noise (SNR ~ 10)
        noise = np.random.normal(0, 0.1, len(t))
        return ringdown + noise

# --- 4. EXECUTION: GW150914 ---

GPS_TARGET = 1126259462.4 # GW150914
print(f"\n[TARGET ACQUIRED] GW150914 (GPS: {GPS_TARGET})")

engine = HyperMorphicEngine()
validator = Validator()

# A. FETCH REAL DATA (H1 and L1)
print("[DATA] Fetching Hanford (H1) and Livingston (L1)...")
try:
    data_h1 = TimeSeries.fetch_open_data('H1', GPS_TARGET-16, GPS_TARGET+16, verbose=False)
    data_l1 = TimeSeries.fetch_open_data('L1', GPS_TARGET-16, GPS_TARGET+16, verbose=False)
    
    # Process H1
    h1_white = data_h1.whiten(4, 2)
    bp_h1 = h1_white.bandpass(30, 1000)
    zoom_h1 = bp_h1.crop(GPS_TARGET + 0.003, GPS_TARGET + 0.1) # Post-merger
    
    # Process L1
    l1_white = data_l1.whiten(4, 2)
    bp_l1 = l1_white.bandpass(30, 1000)
    zoom_l1 = bp_l1.crop(GPS_TARGET + 0.003, GPS_TARGET + 0.1) # Post-merger
    
    print("  > Data locked.")
except Exception as e:
    print(f"  ! Error: {e}. Aborting.")
    sys.exit()

# B. RUN REAL ANALYSIS
print("[TEST 1] Calculating Real SFF...")
t_ax, sff_h1 = engine.calculate_sff(zoom_h1.value, 4096)
t_ax, sff_l1 = engine.calculate_sff(zoom_l1.value, 4096)

real_peaks_h1, floor_h1 = engine.count_anomalies(sff_h1)
print(f"  > Real H1 Anomalies: {real_peaks_h1}")

# C. SURROGATE TESTING (The Shuffle)
print(f"\n[TEST 2] Generating 100 Surrogates (Phase Scrambling)...")
surrogate_counts = []
surrogate_sffs = []

for i in range(100):
    if i % 20 == 0: print(f"  > Simulating Surrogate Universe {i}/100...")
    # Scramble H1 data
    surr_data = validator.generate_surrogate(zoom_h1)
    _, sff_surr = engine.calculate_sff(surr_data.value, 4096)
    peaks, _ = engine.count_anomalies(sff_surr)
    surrogate_counts.append(peaks)
    if i < 20: surrogate_sffs.append(sff_surr) # Store a few for plotting

# Calculate Sigma
mean_surr = np.mean(surrogate_counts)
std_surr = np.std(surrogate_counts)
z_score = (real_peaks_h1 - mean_surr) / (std_surr + 1e-9)

print(f"  > Surrogate Mean Peaks: {mean_surr:.2f} +/- {std_surr:.2f}")
print(f"  > Z-SCORE (SIGMA): {z_score:.2f}")

# D. INJECTION TEST (The Control)
print(f"\n[TEST 3] Classical Injection (Smooth Ringdown)...")
classic_wave = validator.create_classical_injection()
_, sff_classic = engine.calculate_sff(classic_wave, 4096)
classic_peaks, _ = engine.count_anomalies(sff_classic)
print(f"  > Classical Injection Anomalies: {classic_peaks}")

# --- 5. VISUALIZATION REPORT ---

print("\n[VISUAL] Generating Validation Dashboard...")
fig = plt.figure(figsize=(18, 12))

# Panel 1: Real vs Surrogates (The Proof)
ax1 = plt.subplot(2, 2, 1)
ax1.set_title("1. Surrogate Test: Is the Winding Real?", fontsize=14, fontweight='bold', color='white')
# Plot Cloud of Surrogates
for s_sff in surrogate_sffs:
    ax1.plot(t_ax[5:], s_sff[5:], color='gray', alpha=0.1)
# Plot Real H1
ax1.plot(t_ax[5:], sff_h1[5:], color='#00ff00', linewidth=2, label='Real GW150914')
ax1.set_xlabel("Topological Time")
ax1.set_ylabel("SFF Magnitude")
ax1.legend()
ax1.grid(alpha=0.2)

# Panel 2: Distribution of Anomalies (Significance)
ax2 = plt.subplot(2, 2, 2)
ax2.set_title(f"2. Statistical Significance (Sigma = {z_score:.2f})", fontsize=14, fontweight='bold', color='white')
ax2.hist(surrogate_counts, bins=range(0, 15), color='gray', alpha=0.7, label='Random Noise (Surrogates)')
ax2.axvline(x=real_peaks_h1, color='#00ffff', linewidth=3, linestyle='--', label=f'Real Event ({real_peaks_h1})')
ax2.set_xlabel("Number of Anomalies Detected")
ax2.set_ylabel("Frequency")
ax2.legend()
ax2.grid(alpha=0.2)

# Panel 3: Cross-Detector Coherence (H1 vs L1)
ax3 = plt.subplot(2, 2, 3)
ax3.set_title("3. H1 vs L1 Coherence (Global Origin)", fontsize=14, fontweight='bold', color='white')
# Normalize for overlay
norm_h1 = sff_h1[5:] / np.max(sff_h1[5:])
norm_l1 = sff_l1[5:] / np.max(sff_l1[5:])
ax3.plot(t_ax[5:], norm_h1, color='#00ff00', label='Hanford', alpha=0.8)
ax3.plot(t_ax[5:], norm_l1, color='#ff00ff', label='Livingston', alpha=0.8)
# Compute correlation
coherence = np.corrcoef(norm_h1, norm_l1)[0,1]
ax3.text(0.5, 0.9, f"Correlation: {coherence:.2f}", transform=ax3.transAxes, color='white', ha='center', fontweight='bold')
ax3.legend()
ax3.grid(alpha=0.2)

# Panel 4: Classical Control
ax4 = plt.subplot(2, 2, 4)
ax4.set_title("4. Control Test (Smooth GR Injection)", fontsize=14, fontweight='bold', color='white')
ax4.plot(t_ax[5:], sff_classic[5:], color='yellow', linewidth=2, label='Classical Ringdown')
ax4.axhline(y=np.mean(sff_classic[5:])*1.15, color='white', linestyle=':', label='Detection Threshold')
ax4.text(0.5, 0.5, f"Peaks Detected: {classic_peaks}", transform=ax4.transAxes, color='yellow', fontsize=16, ha='center')
ax4.legend()
ax4.grid(alpha=0.2)

plt.figtext(0.5, 0.02, f"HYPERMORPHIC VALIDATOR v4.0 | Z-SCORE: {z_score:.2f} SIGMA", 
            ha="center", fontsize=12, color="#00ffff", fontfamily="monospace", weight='bold')

plt.savefig("hypermorphic_validation_report.png", dpi=150)
plt.show()

# --- FINAL VERDICT ---
print("\n[SCIENTIFIC VERDICT]")
if z_score > 3.0:
    print(f"  >> DISCOVERY CONFIRMED (>3 Sigma). The structure is not noise.")
elif z_score > 2.0:
    print(f"  >> STRONG EVIDENCE (>2 Sigma). Likely astrophysical.")
else:
    print(f"  >> INCONCLUSIVE. indistinguishable from noise.")

if coherence > 0.5:
    print(f"  >> GLOBAL SIGNAL CONFIRMED. H1 and L1 agree.")
else:
    print(f"  >> LOCAL NOISE WARNING. Detectors disagree.")

if classic_peaks == 0:
    print(f"  >> TOOL VALIDATED. No false positives on smooth data.")



[SYSTEM] Initializing Verification Cluster...

[TARGET ACQUIRED] GW150914 (GPS: 1126259462.4)
[DATA] Fetching Hanford (H1) and Livingston (L1)...
  > Data locked.
[TEST 1] Calculating Real SFF...
  > Real H1 Anomalies: 15

[TEST 2] Generating 100 Surrogates (Phase Scrambling)...
  > Simulating Surrogate Universe 0/100...
  > Simulating Surrogate Universe 20/100...
  > Simulating Surrogate Universe 40/100...
  > Simulating Surrogate Universe 60/100...
  > Simulating Surrogate Universe 80/100...
  > Surrogate Mean Peaks: 6.85 +/- 2.91
  > Z-SCORE (SIGMA): 2.80

[TEST 3] Classical Injection (Smooth Ringdown)...
  > Classical Injection Anomalies: 39

[VISUAL] Generating Validation Dashboard...


[SCIENTIFIC VERDICT]
  >> STRONG EVIDENCE (>2 Sigma). Likely astrophysical.
  >> GLOBAL SIGNAL CONFIRMED. H1 and L1 agree.
